<!DOCTYPE html>
<html>

<head>
  <title>Ma premi√®re app AR</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script> 

  <script defer>
    // https://github.com/nikolaiwarner/aframe-chromakey-material
    AFRAME.registerShader("chromakey", {
      schema: {
        src: { type: "map" },
        color: {
          default: { x: 0.0, y: 1.0, z: 0.0 },
          type: "vec3",
          is: "uniform",
        },
        chroma: { type: "bool", is: "uniform" },
        transparent: { default: true, is: "uniform" },
      },

      init: function (data) {
        const videoEl = data.src;
        document.addEventListener("click", () => {
          videoEl.play();
          const entity = document.querySelector("[sound]");
          // console.log(entity)
          // console.log(document.querySelector("#debug-marker"))
          entity.components.sound.playSound();
        });

        var videoTexture = new THREE.VideoTexture(data.src);
        videoTexture.minFilter = THREE.LinearFilter;
        this.material = new THREE.ShaderMaterial({
          uniforms: {
            chroma: {
              type: "b",
              value: data.chroma,
            },
            color: {
              type: "c",
              value: data.color,
            },
            myTexture: {
              type: "t",
              value: videoTexture,
            },
          },
          vertexShader: `
            varying vec2 vUv;

            void main(void)
            {
              vUv = uv;
              vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
              gl_Position = projectionMatrix * mvPosition;
            }
          `,
          fragmentShader: `
              uniform sampler2D myTexture;
              uniform vec3 color;
              uniform bool chroma;
              varying vec2 vUv;

              void main(void)
              {
                vec3 tColor = texture2D( myTexture, vUv ).rgb;
                float a;
                if(chroma == true){
                   a = (length(tColor - color) - 0.5) * 7.0;
                }
                else {
                  a = 1.0;
                }

                gl_FragColor = vec4(tColor, a);
              }
            `,
        });
      },

      update: function (data) {
        this.material.color = data.color;
        this.material.src = data.src;
        this.material.transparent = data.transparent;
      },
    });

    AFRAME.registerComponent("vidhandler", {
      trackedElements: null,

      init: function () {
        this.trackedElements = document.querySelectorAll(
          "a-marker[vidhandler]"
        );
       // console.log(this.trackedElements);
      },
      tick: function () {
        // if(!userConsent){
        //   return;
        // }

        this.trackedElements.forEach((marker) => {
          if (marker.object3D.visible) {
            const vid = document.querySelector(
              marker.attributes.vidreference.value
            );
           // console.log(vid)        
            if (vid.paused) {
              vid.play();
            }
          } else {
            const vid = document.querySelector(
              marker.attributes.vidreference.value
            );
          }
        });
      },
    });
  </script>
</head>

<body>
    <a-scene embedded
    arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best ; changeMatrixMode: modelViewMatrix;"
    renderer="sortObjects: true; antialias: true; colorManagement: true; logarithmicDepthBuffer: true;"

    vr-mode-ui="enabled: false"

    smooth=" true" smoothCount="5" smoothTolerance=".05" smoothThreshold="5"
    
    sourceWidth="800" sourceHeight="600" displayWidth="1280" displayHeight="720">

    <a-assets>
      <img id="img1" src="/assets/logo_ecole_1_coul_defonce_noir.png">
    </a-assets> 
    
        <a-marker type='barcode' value='7'>
           <a-image src="#img1" rotation="270 0 0" width="1" height="2"></a-image>   
            <a-text value="OMGGGGG" 
            side="double" position = "0 0 -1" rotation="270 0 0" 
            width="8"
            color="#FFE08F" align="center" >
            </a-text>

        </a-marker>

        <!-- -->
     <a-assets>
      <video id="vid" src="assets/anim 1.mp4" autoplay="true" loop="true" preload="auto" controls="true"
      muted="true" playsinline="" webkit-playsinline=""></video>
    </a-assets>

        <a-marker vidhandler vidreference="#vid" type='barcode' value='13'>
           <a-entity material="shader: chromakey; src: #vid; chroma: false; color: 0. 0. 1."
            geometry="primitive: plane; width:  1; height:  1" position="0  0  0" rotation="270  0  0" side="double">
          </a-entity>
        </a-marker>
       
     <a-assets>
      <video id="vide" src="assets/anim 2.mp4" autoplay="true" loop="true" preload="auto" controls="true"
      muted="true" playsinline="" webkit-playsinline=""></video>
    </a-assets>

        <a-marker vidhandler vidreference="#vide" type='barcode' value='10'>
           <a-entity material="shader: chromakey; src: #vide; chroma: false; color: 0. 0. 1."
            geometry="primitive: plane; width:  1; height:  1" position="0  0  0" rotation="270  0  0" side="double">
          </a-entity>
        </a-marker>

    <a-assets>
      <video id="vid1" src="assets/bob.mp4" autoplay="true" loop="true" preload="auto" controls="true"
      muted="true" playsinline="" webkit-playsinline=""></video>
    </a-assets>

        <a-marker vidhandler vidreference="#vid1" type='barcode' value='0'>
           <a-entity material="shader: chromakey; src: #vid1; chroma: false; color: 0. 0. 1."
            geometry="primitive: plane; width:  1; height:  1" position="0  0  0" rotation="270  0  0" side="double">
          </a-entity>
        </a-marker>

    <a-assets>
      <video id="vid2" src="assets/jean.mp4" autoplay="true" loop="true" preload="auto" controls="true"
      muted="true" playsinline="" webkit-playsinline=""></video>
    </a-assets>

        <a-marker vidhandler vidreference="#vid2" type='barcode' value='12'>
           <a-entity material="shader: chromakey; src: #vid2; chroma: false; color: 0. 0. 1."
            geometry="primitive: plane; width:  1; height:  1" position="0  0  0" rotation="270  0  0" side="double">
          </a-entity>
        </a-marker>
       
   

     <a-entity camera></a-entity>
  </a-scene>
</body>
</html>